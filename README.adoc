:spring_version: current
:spring_boot_version: 2.2.2.RELEASE
:Controller: https://docs.spring.io/spring/docs/{spring_version}/javadoc-api/org/springframework/stereotype/Controller.html
:DispatcherServlet: https://docs.spring.io/spring/docs/{spring_version}/javadoc-api/org/springframework/web/servlet/DispatcherServlet.html
:SpringApplication: https://docs.spring.io/spring-boot/docs/{spring_boot_version}/api/org/springframework/boot/SpringApplication.html
:ResponseBody: https://docs.spring.io/spring/docs/{spring_version}/javadoc-api/org/springframework/web/bind/annotation/ResponseBody.html
:toc:
:icons: font
:source-highlighter: prettify
:project_id: gs-kotlin-coroutines-hateoas

This guide walks you through the process of creating a “Hello, World” Hypermedia-driven REST web service with Spring and https://kotlinlang.org/docs/coroutines-overview.html[Kotlin Coroutines].

Hypermedia is an important aspect of REST. It lets you build services that decouple client and server to a large extent and let them evolve independently. The representations returned for REST resources contain not only data but also links to related resources. Thus, the design of the representations is crucial to the design of the overall service.


See also : https://spring.io/blog/2019/04/12/going-reactive-with-spring-coroutines-and-kotlin-flow

== What you'll build

//TODO




== What you'll need

:java_version: 1.8
include::https://raw.githubusercontent.com/spring-guides/getting-started-macros/master/prereq_editor_jdk_buildtools.adoc[]

include::https://raw.githubusercontent.com/spring-guides/getting-started-macros/master/how_to_complete_this_guide.adoc[]

[[scratch]]
== Starting with Spring Initializr

image::spring-initializr.jpg[spring-initializr]


If you use Maven, visit the https://start.spring.io/#!type=maven-project&language=kotlin&platformVersion=2.4.3.RELEASE&packaging=jar&jvmVersion=1.8&groupId=com.example&artifactId=kotlin-coroutines-hateoas&name=kotlin-coroutines-hateoas&description=Demo%20project%20for%20Spring%20Boot&packageName=com.example.demo&dependencies=hateoas,webflux[Spring Initializr] to generate a new project with the required dependency (Spring WebFlux and HATOAS).

The following listing shows the `pom.xml` file created when you choose Maven:

.Maven
[caption="pom.xml | "]
====
[source,xml]
----
include::initial/pom.xml[]
----
====

If you use Gradle, visit the https://start.spring.io/#!type=gradle-project&language=kotlin&platformVersion=2.4.3.RELEASE&packaging=jar&jvmVersion=1.8&groupId=com.example&artifactId=kotlin-coroutines-hateoas&name=kotlin-coroutines-hateoas&description=Demo%20project%20for%20Spring%20Boot&packageName=com.example.demo&dependencies=hateoas,webflux[Spring Initializr] to generate a new project with the required dependency (Spring Web and HATEOAS).

The following listing shows the `build.gradle.kts` file created when you choose Gradle:

.Gradle
[caption="build.gradle.kts | "]
====
[source,gradle]
----
include::initial/build.gradle.kts[]
----
====

== Run the Application
To run the application, run the following command in a terminal window (in the initial) directory:

.Gradle
[source,bash]
----
./gradlew bootRun | grep Tomcat
----

If you use Maven, run the following command in a terminal window (in the initial) directory:

.Maven
[source,bash]
----
./mvnw spring-boot:run | grep Tomcat
----

You will see the application will start with a `Tomcat` server. This is because the `spring-boot-starter-hateoas` dependency have a transitive dependency to `spring-boot-starter-web`. To run the `Reactive` stack with `Netty` and `HATEOAS` we have to exclude this transitive dependency.

[source,bash]
----
2021-03-16 07:14:59.026  INFO 76906 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2021-03-16 07:14:59.033  INFO 76906 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2021-03-16 07:14:59.033  INFO 76906 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.43]
2021-03-16 07:14:59.084  INFO 76906 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2021-03-16 07:14:59.431  INFO 76906 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
----



== Exclude transitive dependencies

The `spring-boot-starter-hateoas` dependency have a transitive dependency to `spring-boot-starter-web` who will provide a `Tomcat Server`. In case to use a `Netty Server` from the `spring-boot-starter-webflux` dependencies we have to exclude the transitive dependency from the `spring-boot-starter-hateoas`.

.Gradle
[source,groovy]
.build.gradle.kts
----
include::complete/build.gradle.kts[tags=exclude-web]
----

If you use `Maven` modifies the `pom.xml` file like beloved.

.Maven
[source,xml]
.pom.xml
----
include::complete/pom.xml[tags=exclude-web]
----

Let's check if now the `Netty` server is taken.
Run the following command in a terminal window again :

.Gradle
[source,bash]
----
./gradlew bootRun | grep Netty
----

If you use Maven, run the following command:

.Maven
[source,bash]
----
./mvnw spring-boot:run | grep Netty
----

You will see the application will start up time will be faster, and we will get the following output.

[source,bash]
----
2021-03-16 07:29:55.186  INFO 78288 --- [           main] o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port 8080
----



== Enable HATEOAS
To enable the https://docs.spring.io/spring-hateoas/docs/current/reference/html/#reference[`HATEOAS`] we have defined the `WebStack.WEBFLUX`, and the type of `HypermediaType.HAL` this can be done with the following annotation.
[source,kotlin]
.DemoApplication.kt
----
include::complete/src/main/kotlin/com/example/demo/DemoApplication.kt[tags=enableHATEOAS]
----


== Index (Root) Resource
=== WebFlux
Let's create a `HATEOAS` index controller with https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html[`Reactive Stack`].

[source,kotlin]
.IndexResourceWf.kt
----
include::complete/src/main/kotlin/com/example/demo/index/IndexResourceWebFlux.kt[tags=indexResourceWebFlux]
----

=== Coroutines
Kotlin Coroutines allow writing asynchronous or non-blocking programming without dealing with the futures or reactive streams.
As highlighted by Venkat Subramaniam in his Exploring Coroutines in Kotlin talk, coroutines allow writing concurrent code structured similarly to traditional imperative sequential code.

So let' change our https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html[`Spring WebFlux`] function in a https://kotlinlang.org/docs/coroutines-overview.html[Kotlin Coroutines] with adding the `suspend` keyword and let's turn the `HATEOAS Reactive` `WebFluxLink` _self_ link out of the `Mono` publisher to work with.

NOTE: Each Resource Object SHOULD contain a _self_ link that corresponds with the IANA registered 'self' relation (as defined by [RFC5988]) whose target is the resource's URI.


[source,kotlin]
.IndexResourceCo.kt
----
include::complete/src/main/kotlin/com/example/demo/index/IndexResourceCo.kt[tags=indexResourceCo]
----
<1> Create from the `WebFluxLink`  a `Mono<Link>`
<2> Use the `awaitSingle()` suspending extension function to get the from the `Mono` publisher  without blocking a thread



== Try it out

.WebFlux
[source, bash]
----
$ http :8080/webflux

HTTP/1.1 200 OK
Content-Length: 109
Content-Type: application/hal+json

{
    "_links": {
        "self": {
            "href": "http://localhost:8080/webflux"
        },
        "start-spring": {
            "href": "http://start.spring.io"
        }
    }
}
----


.Coroutines
[source, bash]
----
$ http :8080/
HTTP/1.1 200 OK
Content-Length: 102
Content-Type: application/hal+json

{
    "_links": {
        "self": {
            "href": "http://localhost:8080/"
        },
        "start-spring": {
            "href": "http://start.spring.io"
        }
    }
}
----

== Summary

//TODO



include::https://raw.githubusercontent.com/spring-guides/getting-started-macros/master/footer.adoc[]

